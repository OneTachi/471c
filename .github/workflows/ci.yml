name: CI

on:
  push:
    branches: [ main ]
  pull_request:

env:
  UV_CACHE_DIR: .uv-cache
  UV_SYSTEM_PYTHON: "1"

jobs:
  setup:
    name: Setup environment
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/astral-sh/uv:0.9-python3.14-bookworm
    outputs:
      uv-cache-key: ${{ steps.cache.outputs.cache-hit }}
    steps:
      - uses: actions/checkout@v4

      - name: Install system deps
        run: apt-get update && apt-get install -y git

      - name: Restore uv cache
        id: cache
        uses: actions/cache@v4
        with:
          path: ${{ env.UV_CACHE_DIR }}
          key: uv-${{ hashFiles('uv.lock') }}

      - name: Sync dependencies
        run: uv sync --all-extras --all-packages

  lint:
    name: ruff
    runs-on: ubuntu-latest
    needs: setup
    container:
      image: ghcr.io/astral-sh/uv:0.9-python3.14-bookworm
    steps:
      - name: Run ruff
        run: uv run ruff check .

  pytest:
    name: pytest
    runs-on: ubuntu-latest
    needs: setup
    container:
      image: ghcr.io/astral-sh/uv:0.9-python3.14-bookworm
    steps:
      - name: Run tests
        run: uv run pytest

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: reports/coverage.xml
          report_type: coverage
          
      - name: Upload test results to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: reports/test.xml
          report_type: test_results
